<html>

<head>
    <!-- Load c3.css -->
    <link href="c3.min.css" rel="stylesheet">

    <script src="jquery-3.3.1.min.js"></script>
    <!-- Load d3.js and c3.js -->
    <script src="d3.v3.min.js" charset="utf-8"></script>
    <script src="c3.min.js"></script>
    <script src="bubble.js"></script>
    <script src="pyramid.js"></script>
    <script src="echarts.min.js"></script>
</head>

<body>
    <h1>Weekly commit count by owner/others</h1>
    <div id="chart1"></div>
    <h1>Total commits per working hour (from 8am to 6pm)</h1>
    <div id="chart2"></div>
    <h1>Total bytes count of languages (Torvalds)</h1>
    <div id="chart3"></div>
    <div id="chart4"></div>
    <svg id="chart5"></svg>
    <div id="main" style="width: 1000px;height:800px;"></div>
    <script>
        var languagesBytesCandOthers = {
            "C": 0,
            "Others": 0
        };
        var languagesBytesOthers = {};
        var languagesBytesAll = {};
        //fetchData();

        function fetchData() {
            $.get("https://api.github.com/users/torvalds/repos", function (repos) {
                getLanguages(repos, 0);
            });
        }

        function getLanguages(repos, index) {
            if (index >= repos.length) {
                console.log(languagesBytesAll);
                c3.generate({
                    bindto: '#chart3',
                    data: {
                        json: languagesBytesCandOthers,
                        type: 'pie'
                    },
                    pie: {
                        label: {
                            format: function (value, ratio, id) {
                                return value + ' bytes';
                            }
                        }
                    }
                });
                c3.generate({
                    bindto: '#chart4',
                    data: {
                        json: languagesBytesOthers,
                        type: 'pie'
                    }
                });
                return;
            }
            $.get("https://api.github.com/repos/torvalds/" + repos[index]["name"] + "/languages", function (languages) {
                index++;
                mergeToLanguagesBytes(languages);
                getLanguages(repos, index);
            });
        }

        function mergeToLanguagesBytes(input) {
            for (var propertyName in input) {
                languagesBytesAll[propertyName] = languagesBytesAll[propertyName] || 0;
                languagesBytesAll[propertyName] += input[propertyName]
            }
            for (var propertyName in input) {
                if (propertyName === 'C') {
                    languagesBytesCandOthers["C"] += input[propertyName];
                } else {
                    languagesBytesCandOthers["Others"] += input[propertyName];
                }
            }
            for (var propertyName in input) {
                if (propertyName === 'C') {
                    continue;
                }
                languagesBytesOthers[propertyName] = languagesBytesOthers[propertyName] || 0;
                languagesBytesOthers[propertyName] += input[propertyName]
            }
        }
        c3.generate({
            bindto: '#chart1',
            data: {
                url: 'participation.csv',
                // type: 'bar',
                types: {
                    owner: 'area-spline',
                    others: 'area-spline'
                    // 'line', 'spline', 'step', 'area', 'area-step' are also available to stack
                },
                groups: [
                    [
                        ['owner', 'others']
                    ]
                ]
            },
            axis: {
                x: {
                    tick: {
                        format: function (x) {
                            var today = new Date();
                            today.setDate(today.getDate() - x - 1);
                            return today.toLocaleDateString();
                        }
                    }
                }
            }
        });

        c3.generate({
            bindto: '#chart2',
            data: {
                url: 'workinghour.csv',
                type: 'line'
            },
            axis: {
                x: {
                    tick: {
                        format: function (x) {
                            return x + 8;
                        }
                    }
                }
            }
        });

        (function () {

            // D3 Bubble Chart 

            var diameter = 600;

            var svg = d3.select('#chart3').append('svg')
                .attr('width', diameter)
                .attr('height', diameter);

            var bubble = d3.layout.pack()
                .size([diameter, diameter])
                .value(function (d) {
                    return d.size;
                })
                .padding(3);

            function processData(data) {
                var obj = data;

                var newDataSet = [];

                for (var prop in obj) {
                    newDataSet.push({
                        name: prop,
                        className: prop.toLowerCase(),
                        size: obj[prop] / 100
                    });
                }
                return {
                    children: newDataSet
                };
            }

            $.getJSON('languages.json', function (json) {

                // generate data with calculated layout values
                var nodes = bubble.nodes(processData(json))
                    .filter(function (d) {
                        return !d.children;
                    }); // filter out the outer bubble

                var vis = svg.selectAll('circle')
                    .data(nodes);

                vis.enter().append('circle')
                    .attr('transform', function (d) {
                        return 'translate(' + d.x + ',' + d.y + ')';
                    })
                    .attr('r', function (d) {
                        return d.r;
                    })
                    .attr('class', function (d) {
                        return d.className;
                    });
            });
        })();

        (function () {
            $.getJSON('languages.json', function (json) {
                console.log(json);
                var legend = Object.keys(json)
                console.log(legend);
                var arr = Object.keys(json).map(function (k) {
                    return {
                        name: k,
                        value: json[k]
                    }
                }).sort(function (a, b) {
                    return b.value - a.value
                });;
                console.log(arr)

                $.getJSON('languagesC.json', function (jsonC) {
                    legend.push("C");
                    arrC = Object.keys(jsonC).map(function (k) {
                        return {
                            name: k,
                            value: jsonC[k]
                        }
                    });
                    console.log(arrC);
                    option = {
                        tooltip: {
                            trigger: 'item',
                            formatter: "{a} <br/>{b}: {c} ({d}%)"
                        },
                        legend: {
                            orient: 'vertical',
                            x: 'left',
                            data: legend
                        },
                        series: [{
                                name: '',
                                type: 'pie',
                                // minAngle: 20,
                                selectedMode: 'single',
                                radius: [0, '30%'],
                                center: ['50%','56%'],
                                label: {
                                    normal: {
                                        position: 'inner'
                                    }
                                },
                                labelLine: {
                                    normal: {
                                        show: false
                                    }
                                },
                                data: arrC
                            },
                            {
                                //name: '',
                                type: 'pie',
                                radius: ['40%', '55%'],
                                roseType: true,
                                clockwise: false,
                                center: ['50%','56%'],
                                label: {
                                    small: {
                                        formatter: '{a|{a}}{abg|}\n{hr|}\n  {b|{b}ï¼š}{c}  {per|{d}%}  ',
                                        backgroundColor: '#eee',
                                        borderColor: '#aaa',
                                        borderWidth: 1,
                                        borderRadius: 4,
                                        // shadowBlur:3,
                                        // shadowOffsetX: 2,
                                        // shadowOffsetY: 2,
                                        // shadowColor: '#999',
                                        // padding: [0, 7],
                                        rich: {
                                            a: {
                                                color: '#999',
                                                lineHeight: 22,
                                                align: 'center'
                                            },
                                            // abg: {
                                            //     backgroundColor: '#333',
                                            //     width: '100%',
                                            //     align: 'right',
                                            //     height: 22,
                                            //     borderRadius: [4, 4, 0, 0]
                                            // },
                                            hr: {
                                                borderColor: '#aaa',
                                                width: '100%',
                                                borderWidth: 0.5,
                                                height: 0
                                            },
                                            b: {
                                                fontSize: 16,
                                                lineHeight: 33
                                            },
                                            per: {
                                                color: '#eee',
                                                backgroundColor: '#334455',
                                                padding: [2, 4],
                                                borderRadius: 2
                                            }
                                        }
                                    }
                                },
                                data: arr
                            }
                        ]
                    };
                    var myChart = echarts.init(document.getElementById('main'));
                    myChart.setOption(option);
                });



            });

        })();

        // (function () {
        //     var width = 700,
        //         height = 550,
        //         radius = Math.min(width, height) / 2;

        //     var color = d3.scale.ordinal()
        //         .range(["#3a6fff"
        //         ]);

        //     var svg = d3.select("#chart4").append("svg")
        //         .attr("width", width)
        //         .attr("height", height)
        //         .append("g")

        //     d3.csv("languages.csv", function (error, data) {
        //         var pyramid = d3.pyramid()
        //             .size([width, height])
        //             .value(function (d) {
        //                 return d.bytes;
        //             });

        //         var line = d3.svg.line()
        //             .interpolate('linear-closed')
        //             .x(function (d, i) {
        //                 return d.x;
        //             })
        //             .y(function (d, i) {
        //                 return d.y;
        //             });

        //         var g = svg.selectAll(".pyramid-group")
        //             .data(pyramid(data))
        //             .enter().append("g")
        //             .attr("class", "pyramid-group");

        //         g.append("path")
        //             .attr("d", function (d) {
        //                 return line(d.coordinates);
        //             })
        //             .style("fill", function (d) {
        //                 return color(d.bytes);
        //             });

        //         g.append("text")
        //             .attr({
        //                 "y": function (d, i) {
        //                     if (d.coordinates.length === 4) {
        //                         return (((d.coordinates[0].y - d.coordinates[1].y) / 2) + d.coordinates[
        //                             1].y) + 5;
        //                     } else {
        //                         return (d.coordinates[0].y + d.coordinates[1].y) / 2 + 10;
        //                     }
        //                 },
        //                 "x": function (d, i) {
        //                     return width / 2;
        //                 }
        //             })
        //             .style("text-anchor", "right")
        //             .text(function (d) {
        //                 return d.language;
        //             });
        //     });
        // })();
    </script>
</body>

</html>