<html>

<head>
    <!-- Load c3.css -->
    <link href="c3.min.css" rel="stylesheet">

    <script src="jquery-3.3.1.min.js"></script>
    <!-- Load d3.js and c3.js -->
    <script src="d3.v3.min.js" charset="utf-8"></script>
    <script src="c3.min.js"></script>
    <script src="bubble.js"></script>
</head>

<body>
    <h1>Weekly commit count by owner/others</h1>
    <div id="chart1"></div>
    <h1>Total commits per working hour (from 8am to 6pm)</h1>
    <div id="chart2"></div>
    <h1>Total bytes count of languages (Torvalds)</h1>
    <div id="chart3"></div>
    <div id="chart4"></div>
    <svg id="chart5"></svg>
    <script>
        var languagesBytesCandOthers = {
            "C": 0,
            "Others": 0
        };
        var languagesBytesOthers = {};
        var languagesBytesAll = {};
        //fetchData();

        function fetchData() {
            $.get("https://api.github.com/users/torvalds/repos", function (repos) {
                getLanguages(repos, 0);
            });
        }

        function getLanguages(repos, index) {
            if (index >= repos.length) {
                console.log(languagesBytesAll);
                c3.generate({
                    bindto: '#chart3',
                    data: {
                        json: languagesBytesCandOthers,
                        type: 'pie'
                    },
                    pie: {
                        label: {
                            format: function (value, ratio, id) {
                                return value + ' bytes';
                            }
                        }
                    }
                });
                c3.generate({
                    bindto: '#chart4',
                    data: {
                        json: languagesBytesOthers,
                        type: 'pie'
                    }
                });
                return;
            }
            $.get("https://api.github.com/repos/torvalds/" + repos[index]["name"] + "/languages", function (languages) {
                index++;
                mergeToLanguagesBytes(languages);
                getLanguages(repos, index);
            });
        }

        function mergeToLanguagesBytes(input) {
            for (var propertyName in input) {
                languagesBytesAll[propertyName] = languagesBytesAll[propertyName] || 0;
                languagesBytesAll[propertyName] += input[propertyName]
            }
            for (var propertyName in input) {
                if (propertyName === 'C') {
                    languagesBytesCandOthers["C"] += input[propertyName];
                } else {
                    languagesBytesCandOthers["Others"] += input[propertyName];
                }
            }
            for (var propertyName in input) {
                if (propertyName === 'C') {
                    continue;
                }
                languagesBytesOthers[propertyName] = languagesBytesOthers[propertyName] || 0;
                languagesBytesOthers[propertyName] += input[propertyName]
            }
        }
        c3.generate({
            bindto: '#chart1',
            data: {
                url: 'participation.csv',
                // type: 'bar',
                types: {
                    owner: 'area-spline',
                    others: 'area-spline'
                    // 'line', 'spline', 'step', 'area', 'area-step' are also available to stack
                },
                groups: [
                    [
                        ['owner', 'others']
                    ]
                ]
            },
            axis: {
                x: {
                    tick: {
                        format: function (x) {
                            var today = new Date();
                            today.setDate(today.getDate() - x - 1);
                            return today.toLocaleDateString();
                        }
                    }
                }
            }
        });

        c3.generate({
            bindto: '#chart2',
            data: {
                url: 'workinghour.csv',
                type: 'line'
            },
            axis: {
                x: {
                    tick: {
                        format: function (x) {
                            return x + 8;
                        }
                    }
                }
            }
        });

        (function () {

            // D3 Bubble Chart 

            var diameter = 600;

            var svg = d3.select('#chart3').append('svg')
                .attr('width', diameter)
                .attr('height', diameter);

            var bubble = d3.layout.pack()
                .size([diameter, diameter])
                .value(function (d) {
                    return d.size;
                })
                .padding(3);

            function processData(data) {
                var obj = data;

                var newDataSet = [];

                for (var prop in obj) {
                    newDataSet.push({
                        name: prop,
                        className: prop.toLowerCase(),
                        size: obj[prop]
                    });
                }
                return {
                    children: newDataSet
                };
            }

            $.getJSON('languages.json',function (json) {

                // generate data with calculated layout values
                var nodes = bubble.nodes(processData(json))
                    .filter(function (d) {
                        return !d.children;
                    }); // filter out the outer bubble

                var vis = svg.selectAll('circle')
                    .data(nodes);

                vis.enter().append('circle')
                    .attr('transform', function (d) {
                        return 'translate(' + d.x + ',' + d.y + ')';
                    })
                    .attr('r', function (d) {
                        return d.r;
                    })
                    .attr('class', function (d) {
                        return d.className;
                    });
            });
        })();
    </script>
</body>

</html>